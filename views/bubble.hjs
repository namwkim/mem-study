<!DOCTYPE html>
<html>
  	<head>
	    <title>{{ title }}</title>
	    <link rel='stylesheet' href='/stylesheets/bubble.css' />
	    <link rel='stylesheet' href='/bower_components/bootstrap/dist/css/bootstrap.min.css' />

	    <script src="/javascripts/turkify.js"></script>
	    <script src="/bower_components/jquery/dist/jquery.min.js"></script>
	    <script src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
	    <script src="/bower_components/underscore/underscore-min.js"></script>

	    <script type="text/javascript">
	    	var  INTRO = 0, BUBBLE = 1, DEBRIEF = 2;

	    	var stage = INTRO;
	    	var formSelector = "#mturk-form";
	    	var images = null;
    		var base_url = "/images/db/";
    		var logs = null;

    		var curIdx = 0;
    		var curImg = null;
    		var curBlurImg = null;

    		var assignmentId, hitID, workerId;
    		var clickCount = 0;

	    	$(document).ready(function(){
	    		Initialize();
			});
			function Initialize(){
				$("#bubble").hide();
				$("#debrief").hide();

				// set up AMT form								
				assignmentId 	= gup("assignmentId");
				hitID 			= gup("hitId");
				workerId 		= gup("workerId");
				console.log(hitID);
				console.log(assignmentId);
				console.log(workerId);
				if (assignmentId=="" || hitID=="" || workerId==""){
					alert("You must visit this website through Amazon Mechanical Turk!");
					$("#intro").hide();
					return;
				}
				turkify(formSelector);


				//load target images
	    		$.getJSON('/bubble/images', function(res){
					console.log(res);
					images = res;
				});

				//Set up callback functions
				$(document).keydown(OnKeyPress);

				$(".next-btn").click(function(){
    				ChangeStage(stage+1);
    			});
    			$("#bubble-next-btn").click(NextImage);
    			$("#submit-btn").click(SubmitForm);

    			// log start study
    			LogAction("start", null);

			}
			function SetupImage(idx){
				curImg = new Image();
				curImg.onload = function() {
					curBlurImg = new Image();
					curBlurImg.onload = function(){
						// draw blurred image first
						var canvas = $("#canvas");
						canvas.on('click', OnClickDrawMask);
						var ctx = canvas[0].getContext('2d');
						ctx.drawImage(curBlurImg,0,0);
					}
					curBlurImg.src = images.blurred[idx];
				}
				curImg.src = images.targets[idx];
			}
			function OnClickDrawMask(e){
				var canvas = $("#canvas");
				var ctx = canvas[0].getContext('2d');

				ctx.save();

				var rect = canvas[0].getBoundingClientRect();

			    var x = e.clientX - rect.left;
			    var y = e.clientY - rect.top;

			    ctx.beginPath();
		        ctx.arc(x, y, 25, 0, 6.28, false); //draw the circle
		        ctx.clip();
		        ctx.drawImage(curImg, 0, 0);

		        ctx.restore();

		        //log click actio
		        data = {
		        	center_x: x,
		        	center_y: y,
		        	radius: 25
		        }
		        LogAction("click", data);
		        clickCount++;
			}
			function NextImage(){		
				//log description
				LogAction("explain", {image:images.targets[curIdx], desc: $("#bubble-vis-desc").val()});		

				//increase image index
				curIdx++;
				if (curIdx<images.targets.length){					
					//clear canvas
					var canvas = $("#canvas");
					var ctx = canvas[0].getContext('2d');
					ctx.clearRect(0, 0, canvas.width(), canvas.height())

					//setup a new image
					SetupImage(curIdx);
				}else{
					//all images are used, move on to the next stage
					ChangeStage(stage+1);
				}
				
			}
			function OnKeyPress(e){
				if(e.keyCode == 32){
					e.preventDefault(); //disable spacebar scrolling
				   	// user has pressed space
				   	if (stage==INTRO){
				   		ChangeStage(stage+1);
				   		return;
				   	}				  
				}   	
			}
	    	function ChangeStage(newStage){
	    		stage = newStage;
	    		switch(stage){
	    			case INTRO:
	    				console.log("INTRO");
	    			break;
	    			case BUBBLE:
	    				console.log("BUBBLE");
	    				$("#intro").hide();
	    				$("#bubble").show();
	    				SetupImage(curIdx);
	    			break;
	    			case DEBRIEF:
	    				console.log("DEBRIEF");
	    				$("#bubble").hide();
	    				$("#debrief").show();
	    				LogAction("end", null);
	    		}

	    	}	
	    	function LogAction(action, data){
	    		var log = { 
	    			hitID: hitID,
	    			assignmentId: assignmentId,
	    			workerId: workerId,
	    			action: action,
	    			data: data
	    		};
	    		$.post("/bubble/log", log, function(res){
	    			if (res.code!=0){
	    				alert("Failed to log a worker action!");
	    			}
	    		});

	    	}
	    	function SubmitForm () {
	   			//generating answer data (name-value pairs)
	    		// //1. the number of target images
	    		$("<input type='hidden' name='imageCount' value='" + images.targets.length + "'>").appendTo($(formSelector));
	    		// //2. the number of click counts
	    		$("<input type='hidden' name='clickCount' value='" + clickCount + "'>").appendTo($(formSelector));

	    		// // submit the form to the mturk site
	    		console.log("submit mturk-form...");
	    		console.log("image count: "+images.targets.length);
	    		console.log("click count: "+clickCount);
	    		// console.log("assignmentId: " + $("#mturk-form input[name=assignmentId]").val());
	    		// console.log("targetNumber: " + $("#mturk-form input[name=targetNumber]").val());
	    		// console.log("correctNumber: " + $("#mturk-form input[name=correctNumber]").val());
	    		$(formSelector).submit();	    					
			}		
	    </script>
  	</head>
  	<body>
	  	<div class="container">
	  		<div class="row">
		    	<div id="intro">
					<h1>Bubble Experiment</h1>
					<div class="row">
						<div class="col-md-8">
							<p class="text-justify">
								Welcome! 	
							</p>
						</div>	
						<div class="col-md-4">	
							<img src="/images/teaser.png">
						</div>		
					</div>
					<button type="button" class="next-btn btn btn-primary btn-lg btn-block">
				  		<span class="glyphicon glyphicon-play"></span> Start
					</button>
				</div>	  		
				<div id="bubble">
					<h2>Reveal & Describe</h2>
					<div class="row">
						<div class="col-md-6">
							<canvas id="canvas" width="500" height="500"></canvas>
						</div>
						<div class="col-md-4">
							<form role="form">
								<div class="form-group">									
								    <label for="bubble-vis-desc">Describe the image on the left.</label>
								    <textarea id="bubble-vis-desc" name="desc" class="form-control" rows="20" placeholder="Describe"></textarea>
							  	</div>	
							</form>
							<button id="bubble-next-btn" type="button" class="btn btn-success btn-lg btn-block">
						  		<span class="glyphicon glyphicon-play"></span> Next
							</button>
						</div>
					</div>
				</div>	
				<div id="debrief">
					<h2>Completed!</h2>
					<div class="row">
						<div class="col-md-12">
							<p class="text-justify">
								Thanks for your participation! Upon our confirming your completion of the study, payment will be deposited in your Amazon Payments account.<br><br>
							</p>
						</div>	
						<!--<div class="col-md-4">	
							<img src="/images/teaser.png" class="img-responsive img-rounded">
						</div>-->
					</div>
					<form id="mturk-form">
						<button id="submit-btn" type="button" class="btn btn-primary btn-lg btn-block">
					  		<span class="glyphicon glyphicon-send"></span> Submit
						</button>
					</form>				
				</div>
			</div>
		<div>
  	</body>
</html>