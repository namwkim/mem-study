<!DOCTYPE html>
<html>
  	<head>
	    <title>{{ title }}</title>
	    <link rel='stylesheet' href='/stylesheets/bubble.css' />
	    <link rel='stylesheet' href='/bower_components/bootstrap/dist/css/bootstrap.min.css' />

	    <script src="/javascripts/turkify.js"></script>
	    <script src="/bower_components/jquery/dist/jquery.min.js"></script>
	    <script src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
	    <script src="/bower_components/underscore/underscore-min.js"></script>
	    <script src="/bower_components/bootbox/bootbox.js"></script>
	    <script src="https://www.google.com/recaptcha/api.js" async defer></script>
	    <script type="text/javascript">
	    	var INTRO = 0, CONSENT = 1, MENU = 2, BUBBLE = 3, DEBRIEF = 4;
	    	var MIN_DESC = 150, IMG_WIDTH = 500, IMG_HEIGHT=500;
	    	var stage = INTRO;
	    	var formSelector = "#mturk-form";
	    	var images = null;
	    	var realImages = null;
	    	var practiceImages = null;
    		var base_url = "/images/bubble-db/";
    		var logs = null;
    		var isPractice = false;

    		var curIdx = 0;
    		var curImg = null;
    		var curBlurImg = null;

    		var assignmentId, hitID, workerId;
    		var clickCount = 0, totalClickCount = 0, charCount = 0;

	    	$(document).ready(function(){
	    		Initialize();
			});
			function Initialize(){
				$("#consent").hide();
				$("#menu").hide();
				$("#bubble").hide();
				$("#debrief").hide();

				// set up AMT form								
				assignmentId 	= gup("assignmentId");
				hitID 			= gup("hitId");
				workerId 		= gup("workerId");
				console.log(hitID);
				console.log(assignmentId);
				console.log(workerId);
				if (assignmentId=="ASSIGNMENT_ID_NOT_AVAILABLE"){//preview mode
					$('#intro-start-button').hide();//do not allow a worker to proceed
				}else if (assignmentId=="" || hitID=="" || workerId==""){	// invalid access
					bootbox.alert("You must visit this website through Amazon Mechanical Turk!");
					$("#intro").hide();
					return;
				}
				turkify(formSelector);


				//load target images
	    		$.getJSON('/bubble/images', function(res){
					console.log(res);
					realImages = res;
				});

				//load practice images
				practiceImages = { targets:[], blurred:[] };
				practiceImages.targets.push(base_url+"bubble-practice-1.jpg");
				practiceImages.targets.push(base_url+"bubble-practice-2.jpg");

				practiceImages.blurred.push(base_url+"bubble-practice-1-blurred.jpg");
				practiceImages.blurred.push(base_url+"bubble-practice-2-blurred.jpg");

				//Set up callback functions
				$(document).keydown(OnKeyPress);

				$(".next-btn").click(function(){
    				ChangeStage(stage+1);
    			});
    			$("#bubble-next-btn").click(NextImage);
    			$("#submit-btn").click(SubmitForm);

    			$('#intro-start-button').click(ConfirmRecaptcha);
    			$('#consent-btn').click(ConsentForm);

    			$('#practice-btn').click(StartPractice);
    			$('#skip-btn').click(StartExperiment);

    			$('#bubble-vis-desc').keyup(function(){
    				$('#char-count').text($('#bubble-vis-desc').val().length);
    			})

    			// log start study
    			LogAction("start", null);

			}
			function ConfirmRecaptcha(){
				//check reCAPTCHA
				//console.log(grecaptcha.getResponse());
				$.post('/bubble/recaptcha', {
					recaptcha_response: grecaptcha.getResponse()
				},function(res){
					console.log(res);
					if (res.code!=0){
						console.log("reCAPTCHA failed!");
						bootbox.alert("Verification Failed! Please Try Again...");
					}else{
						console.log("reCAPTCHA success!");
						ChangeStage(stage+1);

					}
				})

			}
			function ConsentForm(){
				var first 	= $("input:radio[name=radioFirst]:checked").val();
				var second 	= $("input:radio[name=radioSecond]:checked").val();
				var third 	= $("input:radio[name=radioThird]:checked").val();

				if (first == "no" || second == "no" || third == "no"){
					bootbox.alert("Sorry, You  are not allowed to participate in this study.");
				}else{
					ChangeStage(stage+1);
				}
			}
			function StartPractice(){
				console.log("StartPractice");
				images 		= practiceImages;
				isPractice 	= true;
				curIdx 		= clickCount = totalClickCount =0;
				ChangeStage(stage+1);
			}
			function StartExperiment(){
				console.log("StartExperiment");
				images 		= realImages;
				isPractice 	= false;
				curIdx 		= clickCount = totalClickCount = 0;
				ChangeStage(stage+1);
			}
			function SetupImage(idx){
				// reset click count
				clickCount = 0;
				$("#click-count").text(clickCount);
				$("#char-count").text(0);

				//clear text area
				$("#bubble-vis-desc").val("");

				curImg = new Image();
				curImg.onload = function() {
					curBlurImg = new Image();
					curBlurImg.onload = function(){
						// draw blurred image first
						var canvas = $("#canvas");
						canvas.off('click');
						canvas.on('click', OnClickDrawMask);
						var ctx = canvas[0].getContext('2d');
						ctx.clearRect(0, 0, canvas.width(), canvas.height())
						ctx.drawImage(curBlurImg,0,0, IMG_WIDTH, IMG_HEIGHT);
					}
					curBlurImg.src = images.blurred[idx];
				}
				curImg.src = images.targets[idx];
			}
			function OnClickDrawMask(e){
				var canvas = $("#canvas");
				var ctx = canvas[0].getContext('2d');

				ctx.save();

				var rect = canvas[0].getBoundingClientRect();

			    var x = e.clientX - rect.left;
			    var y = e.clientY - rect.top;
			    
			    console.log("x, y = " + x + ", " + y);

			    ctx.beginPath();
		        ctx.arc(x, y, 25, 0, 6.28, false); //draw the circle
		        ctx.clip();
		        ctx.drawImage(curImg, 0, 0, IMG_WIDTH, IMG_HEIGHT);

		        ctx.restore();

		        //log click actio
		        data = {
		        	center_x: x,
		        	center_y: y,
		        	radius: 25
		        }
		        LogAction("click", data);
		        clickCount++;
		        $("#click-count").text(clickCount);
		        totalClickCount++;
			}
			function NextImage(){		
				// if the description is less than minumum, can't approve
				var desc = $("#bubble-vis-desc").val();
				if (desc.length<MIN_DESC){
					bootbox.alert("The description should be more than 150 characters!")
					return;
				}
				//log description
				LogAction("explain", {image:images.targets[curIdx], desc: desc});		
				console.log('clickCount = ' + clickCount);
				//increase image index
				curIdx++;
				if (curIdx<images.targets.length){					
					//setup a new image
					SetupImage(curIdx);
				}else{
					//all images are used, move on to the next stage
					if (isPractice!=true)
						ChangeStage(stage+1);
					else
						ChangeStage(stage-1);
				}
				
			}
			function OnKeyPress(e){
				// if(e.keyCode == 32){
				// 	e.preventDefault(); //disable spacebar scrolling
				//    	// user has pressed space
				//    	// if (stage==INTRO){
				//    	// 	ChangeStage(stage+1);
				//    	// 	return;
				//    	// }				  
				// }   	
			}
	    	function ChangeStage(newStage){
	    		HideStage(stage);
	    		stage = newStage;
	    		switch(stage){
	    			case INTRO:
	    				console.log("INTRO");
	    			break;
	    			case CONSENT:
	    				console.log("CONSENT");
	    				$("#consent").show();
	    			break;
	    			case MENU:
	    				console.log("MENU");
	    				$("#menu").show();
    				break;
	    			case BUBBLE:
	    				console.log("BUBBLE");
	    				$("#bubble").show();
	    				SetupImage(curIdx);
	    			break;
	    			case DEBRIEF:
	    				console.log("DEBRIEF");
	    				$("#debrief").show();
	    				LogAction("end", null);
	    		}

	    	}	
	    	function HideStage(prevStage){
	    		switch(prevStage){
	    			case INTRO: 	$("#intro").hide(); 	break;
	    			case CONSENT:	$("#consent").hide();	break;
	    			case MENU:		$("#menu").hide();		break;
	    			case BUBBLE: 	$("#bubble").hide();	break;
	    			case DEBRIEF: 	$("#debrief").hide(); 	break;
	    		}
	    	}
	    	function LogAction(action, data){
	    		if (isPractice!=true) return;
	    		var log = { 
	    			hitID: hitID,
	    			assignmentId: assignmentId,
	    			workerId: workerId,
	    			action: action,
	    			data: data
	    		};
	    		$.post("/bubble/log", log, function(res){
	    			if (res.code!=0){
	    				bootbox.alert("Failed to log a worker action!");
	    			}
	    		});

	    	}
	    	function SubmitForm () {
	   			//generating answer data (name-value pairs)
	   			
	    		// 1. Target Image Count
	    		$("<input type='hidden' name='imageCount' value='" + images.targets.length + "'>").appendTo($(formSelector));
	    		// 2. Total Click Count
	    		$("<input type='hidden' name='clickCount' value='" + totalClickCount + "'>").appendTo($(formSelector));
	    		// 3. Avg Click Count
	    		$("<input type='hidden' name='avgClickCount' value='" + (totalClickCount/images.targets.length) + "'>").appendTo($(formSelector));

	    		var gender 	= $("input:radio[name=gender]:checked").val();
	    		var age 	= $("input:radio[name=ageGroup]:checked").val();
	    		var ethnic 	= "";
	    		if ($("#ethnicAsian").prop('checked'))		ethnic += "/" + $("#ethnicAsian").val();
	    		if ($("#ethnicLatino").prop('checked'))		ethnic += "/" + $("#ethnicLatino").val();
	    		if ($("#ethnicPacific").prop('checked'))	ethnic += "/" + $("#ethnicPacific").val();
	    		if ($("#ethnicAfrican").prop('checked'))	ethnic += "/" + $("#ethnicAfrican").val();
	    		if ($("#ethnicMiddle").prop('checked'))		ethnic += "/" + $("#ethnicMiddle").val();
	    		if ($("#ethnicWhite").prop('checked'))		ethnic += "/" + $("#ethnicWhite").val();
	    		if ($("#ethnicEastInd").prop('checked'))	ethnic += "/" + $("#ethnicEastInd").val();
	    		if ($("#ethnicNative").prop('checked'))		ethnic += "/" + $("#ethnicNative").val();
	    		if ($("#ethnicOther").prop('checked'))		ethnic += "/" + $("#ethnicOther").val();

	    		// // submit the form to the mturk site
	    		console.log("Submiting mturk-form...");
	    		console.log("imageCount: "+images.targets.length);
	    		console.log('totalClickCount = ' + totalClickCount);
	   			console.log('avgClickCount = ' + (totalClickCount/images.targets.length) );

	   			console.log(gender);
	   			console.log(age);
	   			console.log(ethnic);

	    		// console.log("assignmentId: " + $("#mturk-form input[name=assignmentId]").val());
	    		// console.log("targetNumber: " + $("#mturk-form input[name=targetNumber]").val());
	    		// console.log("correctNumber: " + $("#mturk-form input[name=correctNumber]").val());
	    		//$(formSelector).submit();	    					
			}		
	    </script>
  	</head>
  	<body>
	  	<div class="container">
	  		<div class="row">
		    	<div id="intro">					
					<div class="row">
						<div class="col-md-12">
							<h2>Bubble Study</h2>
							<p class="text-justify">
								Welcome! In this short study, you will be given a series of visualization images and asked to describe the images as much as possible. Each image is heavily blurred so that you can only see a rough outline of the image. However, you can click to reveal small, circular areas of the image ("bubbles") to inspect the full details. We will approve your work based on the description you provided, and will also refer to the number of clicks on each image.
							</p><br>
							<img class="center-block thumbnail" height="350" src="/images/bubble-db/study_overview.png">
							<br>
							
							<div class="g-recaptcha" align="center" data-sitekey="6Lc4B_8SAAAAAMicUMBTqf16BHC5xLSlrrX2YVYB" ></div>
							<br>
							<button id="intro-start-button" type="button" class="btn btn-success btn-lg btn-block">
					  			<span class="glyphicon glyphicon-play"></span> Start
							</button>
						
						</div>	
					</div>
				</div>	  
				<div id="consent">
					<div class="row">
						<div class="col-md-12">
							<h2>STATEMENT OF INFORMED CONSENT</h2>
							<p class="text-justify">								
								<br>								
								<strong>Purpose of research:</strong> I am studying the memorability of data visualizations and information graphics. The elements of each image, such as type of graph and layout, are of interest in determining what components may aid memorability. This study focuses on the impact that titles have on visualization recognition and memorability. 
								<br><br>
								<strong>What your participation in this study will involve:</strong>
								Reading a summary of relevant background information.
								Seeing a sequence of images for 2 seconds
								Pressing a key every time when presented with an image for the second time in the sequence 
								<br><br>
								<strong>Time required:</strong> Participation will take approximately 5 minutes.
								<br><br>
								<strong>Risks:</strong> There are no anticipated risks associated with participating in this study. The effects of viewing the images should be comparable to those you would experience from viewing a computer monitor for 5 minutes.
								<br><br>
								<strong>Confidentiality:</strong> Your participation in this study will remain confidential, and your identity will not be stored with your data. Your responses will be assigned a code number, and the list connecting your Amazon worker ID with this code number will be kept in a locked room and will be destroyed upon completion of the project.
								<br><br>
								<strong>Participation and withdrawal:</strong> Your participation in this study is completely voluntary, and you may withdraw at any time without penalty. You may skip any questions/tasks that you do not want to complete.
								<br><br>
								<strong>Researcher Contact Information:</strong> If you have questions about this research, please contact Nam Wook Kim, (Maxwell Dworkin 142, 33 Oxford St , Cambridge, MA, 02138, namwkim@seas.harvard.edu). 
								<br><br>
								<strong>Faculty Sponsor:</strong> Prof. Hanspeter Pfister (33 Oxford Street, Maxwell-Dworkin Rm 227, Cambridge, MA 02138, pfister@seas.harvard.edu, 617-496-8269)
								<br><br>
								<strong>Agreement:</strong>
								The nature and purpose of this research have been satisfactorily explained to me and I agree to become a participant in the study as described above. I understand that I am free to discontinue participation at any time if I so choose, and that the investigator will gladly answer any questions that arise during the course of the research.
								<br><br>

							</p>
							<div class="panel panel-default">
  								<div class="panel-body">
									<table class="table table-hover">
										<thead>
											<tr>
												<th colspan="2">
													The experimenter will now verify the following information:
												</th>
											</tr>
										</thead>
										<tbody>
											<tr>
												<td>1. You are age 18 or older.</td>
												<td>
													<label class="radio-inline text-right" align="right">
													  <input type="radio" name="radioFirst" id="radioFirst1" value="yes"> Yes
													</label>
													<label class="radio-inline">
													  <input type="radio" name="radioFirst" id="radioFirst2" value="no" checked> No
													</label>
												</td>
											</tr>
											<tr>
												<td>2. You have read and understand the information above.</td>
												<td>
													<label class="radio-inline">
													  <input type="radio" name="radioSecond" id="radioSecond1" value="yes"> Yes
													</label>
													<label class="radio-inline">
													  <input type="radio" name="radioSecond" id="radioSecond2" value="no" checked> No
													</label>				
												</td>
											</tr>
											<tr>
												<td>3. You want to participate in this research and continue with the research activity</td>
												<td>
													<label class="radio-inline">
													  <input type="radio" name="radioThird" id="radioThird1" value="yes"> Yes
													</label>
													<label class="radio-inline">
													  <input type="radio" name="radioThird" id="radioThird2" value="no" checked> No
													</label>
												</td>
											</tr>
										</tbody>
									</table>
								</div>
							</div>
							<button id="consent-btn" type="button" class="btn btn-success btn-lg btn-block">
					  			<span class="glyphicon glyphicon-ok"></span> Confirm
							</button>							
						</div>
					</div>
				</div>	
				<div id="menu">					
					<div class="row">
						<div class="col-md-12">
							<h2>Bubble Study Instruction</h2>
							<p class="text-justify">
								Welcome again! You may try the practice, or skip right on to the study. The real study will be just like the practice except more images. 
								<br><br>
								You will be paid <strong>$0.40</strong> for participating in this study which is expected to last about <strong>5 minutes</strong>.
								<br><br>
								You will be given <strong>5 visualization images</strong> and asked to <strong>describe the images</strong> in as much detail as possible (minimum 150 characters). Each image is <strong>heavily blurred</strong> so that you can only see a rough outline of the image. However, you can <strong>click to reveal</strong> small, circular areas of the image ("bubbles") to inspect the full details.							
							</p>
							<br>
							<img class="center-block thumbnail" height="350" src="/images/bubble-db/study_overview.png">
							<br>
							<div class="btn-group btn-group-lg" style="width:100%" role="group" aria-label="...">
								<button id="practice-btn" type="button" style="width:50%" class="btn btn-primary">
							  		<span class="glyphicon glyphicon-pencil"></span> Start Practice
								</button>
								<button id="skip-btn" type="button" style="width:50%" class="btn btn-success">
							  		<span class="glyphicon glyphicon-play"></span> Start Study
								</button>
							</div>
							
						</div>
					</div>
				</div>
				<div id="bubble">	
					<h2>Click and Describe the Image.</h2>				
					<div class="row">
						<div class="col-md-6">							
							<canvas id="canvas" width="500" height="500"></canvas>
						</div>
						<div class="col-md-4">
							<form role="form">
								<div class="form-group">									
								    <label for="bubble-vis-desc">
								    	<span class="badge"><span id="click-count">0</span> clicks</span>
								    	<span class="badge"><span id="char-count">0</span> characters</span></label>
								    <textarea id="bubble-vis-desc" name="desc" class="form-control" rows="20" placeholder="Describe the image in as much as possible..."></textarea>
							  	</div>	
							</form>
							<button id="bubble-next-btn" type="button" class="btn btn-success btn-lg btn-block">
						  		<span class="glyphicon glyphicon-play"></span> Next
							</button>
						</div>
					</div>
				</div>	
				<div id="debrief">
					<h2>Completed!</h2>
					<div class="row">
						<div class="col-md-12">
							<p class="text-justify">
								Thanks for your participation! Upon our confirming your completion of the study, payment will be deposited in your Amazon Payments account.<br><br>
							</p>
							<div class="panel panel-default">
  								<div class="panel-body">
									<table class="table table-hover">
										<thead>
											<tr>
												<th colspan="2">
													Survey
												</th>
											</tr>
										</thead>
										<tbody>
											<tr>
												<td>Gender</td>
												<td>
													<label class="radio-inline text-right" align="right">
													  <input type="radio" name="gender" id="genderMale" value="female"> Female
													</label>
													<label class="radio-inline">
													  <input type="radio" name="gender" id="genderFemale" value="male"> Male
													</label>
												</td>
											</tr>
											<tr>
												<td>Age</td>
												<td>
													<div class="radio">
														<label class="radio-inline">
														  <input type="radio" name="ageGroup" id="ageGroup1" value="ageGroup18"> 18 to 24
														</label>
														<label class="radio-inline">
														  <input type="radio" name="ageGroup" id="ageGroup2" value="ageGroup25"> 25 to 34
														</label>
														<label class="radio-inline">
														  <input type="radio" name="ageGroup" id="ageGroup3" value="ageGroup35"> 35 to 44
														</label>
													</div>
													<div class="radio">
														<label class="radio-inline">
														  <input type="radio" name="ageGroup" id="ageGroup4" value="ageGroup45"> 45 to 54
														</label>
														<label class="radio-inline">
														  <input type="radio" name="ageGroup" id="ageGroup5" value="ageGroup55"> 55 to 64
														</label>
														<label class="radio-inline">
														  <input type="radio" name="ageGroup" id="ageGroup6" value="ageGroup65"> 65 and over
														</label>
													</div>
												</td>
											</tr>
											<tr>
												<td>Ethnicity</td>
												<td>
													<div class="checkbox">
														<label class="checkbox-inline">
														  	<input type="checkbox" id="ethnicAsian" value="Asian"> Asian
														</label>
														<label class="checkbox-inline">
														  	<input type="checkbox" id="ethnicLatino" value="Latino_Hispanic"> Latino / Hispanic
														</label>
														<label class="checkbox-inline">
														  	<input type="checkbox" id="ethnicPacific" value="Pacific_Islander"> Pacific Islander
														</label>
													</div>
													<div class="checkbox">
														<label class="checkbox-inline">
														  	<input type="checkbox" id="ethnicAfrican" value="Black_African"> Black / Afracan Descent
														</label>
														<label class="checkbox-inline">
														  	<input type="checkbox" id="ethnicMiddle" value="Middle_Eastern"> Middle Eastern
														</label>
														<label class="checkbox-inline">
														  	<input type="checkbox" id="ethnicWhite" value="White_Caucasian"> White / Caucasian
														</label>
													</div>	
													<div class="checkbox">
														<label class="checkbox-inline">
														  	<input type="checkbox" id="ethnicEastInd" value="East_Indian"> East Indian
														</label>
														<label class="checkbox-inline">
														  	<input type="checkbox" id="ethnicNative" value="Native_American"> Native American
														</label>
														<label class="checkbox-inline">
														  	<input type="checkbox" id="ethnicOther" value="Other"> Other
														</label>
													</div>																																						
												</td>
											</tr>
											<tr>
												<td>Feedback</td>
												<td>
													<textarea id="survey-feedback" name="feedback" class="form-control" rows="3" placeholder="If you have any feedback, comments, or suggestions, please describe them here."></textarea>
												</td>
											</tr>

										</tbody>
									</table>
								</div>
							</div>							
						</div>	
						<!--<div class="col-md-4">	
							<img src="/images/teaser.png" class="img-responsive img-rounded">
						</div>-->
					</div>
					<form id="mturk-form">
						<button id="submit-btn" type="button" class="btn btn-success btn-lg btn-block">
					  		<span class="glyphicon glyphicon-send"></span> Submit
						</button>
					</form>				
				</div>
			</div>
		<div>
  	</body>
</html>