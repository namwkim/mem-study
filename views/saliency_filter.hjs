<!DOCTYPE html>
<html>

<head>
  <title>{{ title }}</title>
  <link rel='stylesheet' href='/bower_components/bootstrap/dist/css/bootstrap.min.css' />
  <link rel='stylesheet' href='/bower_components/bootstro/bootstro.min.css' />
  <link rel='stylesheet' href='/bower_components/jquery-ui/themes/smoothness/jquery-ui.min.css' />
  <link rel='stylesheet' href='/bower_components/seiyria-bootstrap-slider/dist/css/bootstrap-slider.min.css' />
  <link rel='stylesheet' href='/stylesheets/bubble_admin.css' />

  <script src="/bower_components/jquery/dist/jquery.min.js"></script>
  <script src="/bower_components/jquery-ui/jquery-ui.min.js"></script>
  <script src="/bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
  <script src="/bower_components/bootstro/bootstro.min.js"></script>
  <script src="/bower_components/underscore/underscore-min.js"></script>
  <script src="/bower_components/bootbox/bootbox.js"></script>
  <script src="/javascripts/heatmap.js-2.0/build/heatmap.js"></script>
  <script src="/bower_components/angular/angular.min.js"></script>
  <script src="/bower_components/spinjs/spin.js"></script>
  <script src="/bower_components/seiyria-bootstrap-slider/dist/bootstrap-slider.min.js"></script>
  <script src="/javascripts/turkify.js"></script>

  <script type="text/javascript">
    var PAGE_SIZE = 30;
    var pageNum = 0;
    var totalPage = 597;
    var loadComplete = 0;
    var progress = 0;
    var logs = [];
    $(document).ready(function() {
      Initialize();
    });

    var app = angular.module('myApp', [], function($interpolateProvider) {
      $interpolateProvider.startSymbol('<%');
      $interpolateProvider.endSymbol('%>');
    });
    app.directive("repeatEnd", function($timeout) {
      return {
        restrict: "A",
        link: function(scope, element, attrs) {
          if (scope.$last) {
            $timeout(function() {
              $(element).parent().children()[0].click();
            }, 1)
          }
        }
      };
    });
    app.controller('imageCtrl', function($scope, $http) {

      $scope.pages      = {};
      $scope.totalPage  = null;
      $scope._          = window._;     
      $scope.images     = null;
      $scope.allImages  = null;
      $scope.checks     = null;
      $scope.checkMap   = {};
      $scope.IMG_PATH   = "images/all5k/";


      $scope.rater = gup("rater")
      if ($scope.rater != "Michelle" && $scope.rater != "Zoya" && $scope.rater != "Nam") {
        $scope.rater = "Nam";
      }

      /* Initialize */
      $http.get('/saliency/images').success(function(allImages) {
        $http.get('/saliency/checks', {
          params: {
            rater: $scope.rater
          }
        }).success(function(checks) {
          console.log("images:");
          console.log(allImages);
          console.log("checks:");
          console.log(checks);
          

          $scope.allImages = allImages;
          $scope.totalPage = Math.ceil(allImages.length/PAGE_SIZE);

          $scope.checks = checks;

          //construct page
          for (var i=0; i<$scope.totalPage; i++){
            var images  = allImages.slice(i*PAGE_SIZE, i*(PAGE_SIZE+1));
            var allDone = true;
            images.forEach(function(img){
              var check = _.findWhere(checks, {
                image: img.filename
              });
              if (check==undefined){
                allDone   = false;  
                img.done  = false;
              }else{
                img.done  = true;
                checkMap[img.filename] = check;
              }
            })
            $scope.pages[i] = {
              images: images,
              done: allDone
            }
          }

          loadComplete = 1;
        });
      })


      $scope.onCheck = function() {
        //update check status for image
        var img = _.findWhere($scope.images, {
          filename: $scope.check.image
        });
        
        img.done = true;

        // update evaluation
        $http.post('/saliency/check', $scope.check)
          .success(function() {
            console.log("check updated!");
          })
        //update page check status
        $scope.pages[pageNum].allDone = $scope.pages[pageNum].images.every(function(img){
          return img.done;
        });
      }


      $scope.onClickImage = function(e, filename) {
        if (e != null) {
          $("#image-list a.active").removeClass("active");
          $(e.currentTarget).addClass("active");
        }
        $scope.check = checkMap[filename];
        drawImage($scope.IMG_PATH+filename);

      }
      $scope.onClickPage = function(e, pnum) {

        pageNum = pnum;
        if (e != null) {
          $("ul.pagination li.active").removeClass("active");
          $(e.currentTarget).addClass("active");
        }
        if ($scope.pages[pageNum] == null) { // if not loaded
          $scope.images = $scope.pages[pageNum].images;

        }

      }

      //$scope.onClickPage(null, 0);
    });

    function Initialize() {
      $('[data-toggle="tooltip"]').tooltip()
      $('[data-toggle="popover"]').popover({
        trigger: "hover",
        container: 'body'
      })
      $("#progress-modal").modal({
        keyboard: false,
        backdrop: "static"
      });
      // progressbar
      var timer;
      timer = setInterval(function() {
        //check if complete
        if (loadComplete == 1) {
          console.log("load complete!");
          $("#progress-bar").css('width', "100%").attr('aria-valuenow', 100);
          $("#progress-modal").modal("hide");
          clearInterval(timer);
          return;
        }
        progress += 15;
        $("#progress-bar").css('width', progress + '%').attr('aria-valuenow', progress);

      }, 500);


    }

    function drawImage(imagePath, callback) {
      //draw image
      var img = new Image();
      img.onload = function() {
        var canvas = $("#saliency-canvas");
        //console.log(this.naturalWidth);
        var ctx = canvas[0].getContext('2d');
        ctx.clearRect(0, 0, canvas[0].width, canvas[0].height);

        var newSize = CalcNewImageSize(this.naturalWidth, this.naturalHeight, canvas[0].width, canvas[0].height);
        ctx.drawImage(img, 0, 0, newSize.width, newSize.height);

        if (callback) callback.call(this);

      }
      img.src = imagePath;
    }

   
    function CalcNewImageSize(imgWidth, imgHeight, canvasWidth, canvasHeight) {
      //console.log("(canvasWidth, canvasHeight) = " + canvasWidth + ", " + canvasHeight);
      //console.log("(oldWidth, oldHeight) = " + imgWidth + ", " + imgHeight);
      var newWidth = imgWidth;
      var newHeight = imgHeight;
      if (newWidth > canvasWidth) {
        newWidth = canvasWidth;
        var wratio = canvasWidth / imgWidth;
        newHeight = wratio * newHeight;
      }
      if (newHeight > canvasHeight) {
        newHeight = canvasHeight;
        var hratio = canvasHeight / imgHeight;
        newWidth = hratio * newWidth;
      }
      //console.log("(newWidth, newHeight) = " + newWidth + ", " + newHeight);
      return {
        width: newWidth,
        height: newHeight
      };
    }

  </script>
</head>

<body ng-app="myApp" ng-controller="imageCtrl">
  <!-- Progress Modal -->
  <div class="modal fade" id="progress-modal" tabindex="-1" role="dialog" aria-labelledby="progress-modal-label" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title" id="progress-modal-label">Loading Images...</h4>
        </div>
        <div class="modal-body">
          <div class="progress">
            <div id="progress-bar" class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100" style="width: 0%;">
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="container">
    <h3><span class="glyphicon glyphicon-search" aria-hidden="true"></span> Image Filtering Interface (<% rater %>)</h3>
    <div class="row">
      <div class="col-md-2">
        <div class="panel panel-default">
          <div class="panel-heading">Pages</div>
          <nav class="text-center">

        <!--     <ul class="pagination pagination-sm" style="margin:0 auto; float: none;" >
              <li class="animate-repeat" ng-repeat="x in pages" ng-class="{active: $first}" ng-click="onClickPage($event, x)" repeat-end>
                <a href="#">
                  <% x %>
                </a>
              </li>
            </ul> -->
          </nav>
        </div>
      </div>
      <div class="col-md-2">
        <div id="image-panel" class="panel panel-default">
          <div id="load-alert" class="alert alert-danger" role="alert" style="display:none">Loading...</div>
          <!-- Default panel contents -->
          <div class="panel-heading">Images</div>
          <!-- List group -->
          <div id="image-list" class="list-group" style="max-height:1000px;overflow-y:scroll;">
            <a href="#" class='list-group-item' ng-repeat="x in images" ng-class="{active: $first}" ng-click="onClickImage($event, x.filename)" style="word-break: break-all;" repeat-end><span class="glyphicon glyphicon-ok text-success" style="margin-right:8px;" aria-hidden="true" ng-show="x.doneCheck"></span><% x.filename %></a>
          </div>
        </div>
      </div>
      <div class="col-md-8">
        <div class="panel panel-default">
          <div class="panel-heading">Evaluation</div>
          <div class="panel-body">
            <div class="well">
              <div class="input-group">
                <strong>Filter? </strong>
                <br>
                <span style="margin-left:20px;"></span>
                <label class="radio-inline">
                  <input type="radio" name="filter" ng-model="check.filter" value="1" ng-change="onCheck()">Use</label>
                <label class="radio-inline">
                  <input type="radio" name="filter" ng-model="check.filter" value="2" ng-change="onCheck()">Do Not Use</label>

              </div>
            </div>
            
            <canvas id="saliency-canvas" width="1000" height="600"></canvas>
          </div>

        </div>
      </div>

    </div>
  <div>
</body>

</html>
